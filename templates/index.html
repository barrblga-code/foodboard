{% extends "base.html" %}
{% block content %}
<h1 class="mb-4">
    {% if nearby_mode %}
        –û–±—ä—è–≤–ª–µ–Ω–∏—è —Ä—è–¥–æ–º —Å {{ current_city or '–≤–∞—à–µ–π –ª–æ–∫–∞—Ü–∏–µ–π' }} (—Ä–∞–¥–∏—É—Å 400 –∫–º)
    {% else %}
        –í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
    {% endif %}
</h1>

{% if nearby_mode %}
    <p class="mb-4"><a href="{{ url_for('index') }}">‚Üê –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</a></p>
{% endif %}

<!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
<div class="mb-4 p-3 border rounded bg-white">
    <form class="row g-3 align-items-end">
        <div class="col-md-5">
            <input type="text" name="q" class="form-control" placeholder="–ü–æ–∏—Å–∫ (—Ç–æ—Ä—Ç, –æ–≥—É—Ä—Ü—ã, –º—ë–¥...)" value="{{ search_query }}">
        </div>
        <div class="col-md-5">
            <input type="text" name="near_city" class="form-control" placeholder="–ì–æ—Ä–æ–¥ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ä—è–¥–æ–º" value="{{ current_city or '' }}">
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-success w-100">–ù–∞–π—Ç–∏</button>
        </div>
    </form>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ -->
{% if not nearby_mode %}
<div class="mb-4">
    <button id="nearby-btn" class="btn btn-primary">üìç –û—Ç –º–æ–µ–π —Ç–µ–∫—É—â–µ–π –ª–æ–∫–∞—Ü–∏–∏</button>
    <small class="text-muted ms-2">(–±—Ä–∞—É–∑–µ—Ä –ø–æ–ø—Ä–æ—Å–∏—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ)</small>
</div>
{% endif %}

<script>
document.getElementById('nearby-btn')?.addEventListener('click', () => {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            position => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const currentParams = new URLSearchParams(window.location.search);
                currentParams.set('lat', lat);
                currentParams.set('lon', lon);
                window.location.search = currentParams.toString();
            },
            error => {
                let msg = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é.';
                if (error.code === error.PERMISSION_DENIED) {
                    msg += ' –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                } else if (error.code === error.POSITION_UNAVAILABLE) {
                    msg += ' –õ–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–≤–æ–∑–º–æ–∂–Ω–æ VPN –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏).';
                } else {
                    msg += ' –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –ø–æ –≥–æ—Ä–æ–¥—É.';
                }
                alert(msg);
            }
        );
    } else {
        alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –ø–æ –≥–æ—Ä–æ–¥—É.');
    }
});
</script>

<!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
<div class="row mb-4">
    <div class="col">
        <h5>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:</h5>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm me-2">–í—Å–µ</a>
        {% for cat in categories %}
            <a href="{{ url_for('category', cat_id=cat.id) }}" class="btn btn-outline-success btn-sm me-2">{{ cat.name }}</a>
        {% endfor %}
    </div>
</div>

<!-- –û–±—ä—è–≤–ª–µ–Ω–∏—è -->
<div class="row">
    {% for ad in ads %}
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            {% if ad.image %}
                <img src="{{ url_for('static', filename='uploads/' + ad.image) }}" class="card-img-top" style="height:200px; object-fit:cover;">
            {% endif %}
            <div class="card-body d-flex flex-column">
                <h5 class="card-title">{{ ad.title }}</h5>
                <p class="card-text flex-grow-1">{{ ad.description[:150] }}...</p>
                <p class="card-text"><strong>–¶–µ–Ω–∞: {{ ad.price }} ‚ÇΩ</strong></p>
                {% if nearby_mode and ad.distance is defined %}
                    <p class="card-text text-success"><strong>‚âà {{ ad.distance }} –∫–º –æ—Ç –≤–∞—Å</strong></p>
                {% endif %}
                <p class="card-text text-muted"><small>–ü—Ä–æ–¥–∞–≤–µ—Ü –∏–∑: {{ ad.seller.city }}</small></p>

                {% if current_user.is_authenticated %}
                    <form method="POST" action="{{ url_for('toggle_favorite', ad_id=ad.id) }}" class="mt-2">
                        {% if ad in current_user.favorites %}
                            <button type="submit" class="btn btn-outline-danger btn-sm">–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ</button>
                        {% else %}
                            <button type="submit" class="btn btn-outline-primary btn-sm">–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
                        {% endif %}
                    </form>
                {% endif %}

                <a href="{{ url_for('ad_detail', ad_id=ad.id) }}" class="btn btn-success mt-auto">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
            </div>
        </div>
    </div>
    {% else %}
    <p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –≥–æ—Ä–æ–¥.</p>
    {% endfor %}
</div>
{% endblock %}