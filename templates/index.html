{% extends "base.html" %}
{% block content %}
<h1 class="mb-4">
    {% if nearby_mode %}
        –û–±—ä—è–≤–ª–µ–Ω–∏—è —Ä—è–¥–æ–º (—Ä–∞–¥–∏—É—Å {{ radius }} –∫–º)
    {% else %}
        –í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
    {% endif %}
</h1>

{% if nearby_mode %}
    <p class="mb-4"><a href="{{ url_for('index') }}">‚Üê –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</a></p>
{% endif %}

<!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ + —Ä–∞–¥–∏—É—Å -->
<div class="mb-4 p-3 border rounded bg-white">
    <form id="searchForm" class="row g-3 align-items-end">
        <div class="col-md-4">
            <input type="text" name="q" class="form-control" placeholder="–ü–æ–∏—Å–∫ (—Ç–æ—Ä—Ç, –æ–≥—É—Ä—Ü—ã, –º—ë–¥...)" value="{{ search_query }}">
        </div>
        <div class="col-md-3">
            <input type="text" name="near_city" class="form-control" placeholder="–ì–æ—Ä–æ–¥ (–û—Ä–µ–Ω–±—É—Ä–≥, –®–∞—Ä–ª—ã–∫...)" value="{{ current_city or '' }}">
        </div>
        <div class="col-md-2">
            <select name="radius" class="form-select" id="radiusSelect">
                <option value="100" {% if radius == 100 %}selected{% endif %}>100 –∫–º</option>
                <option value="200" {% if radius == 200 %}selected{% endif %}>200 –∫–º</option>
                <option value="300" {% if radius == 300 %}selected{% endif %}>300 –∫–º</option>
                <option value="400" {% if radius == 400 or not radius %}selected{% endif %}>400 –∫–º</option>
                <option value="500">500 –∫–º</option>
                <option value="1000">–í—Å—è –æ–±–ª–∞—Å—Ç—å</option>
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-success w-100">–ù–∞–π—Ç–∏</button>
        </div>
    </form>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ -->
<button id="nearby-btn" class="btn btn-primary mb-4">üìç –û—Ç –º–æ–µ–π —Ç–µ–∫—É—â–µ–π –ª–æ–∫–∞—Ü–∏–∏</button>

<script>
// –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ –∫–Ω–æ–ø–∫–µ
document.getElementById('nearby-btn').addEventListener('click', () => {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            position => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const radius = document.getElementById('radiusSelect').value;
                window.location.href = `/?lat=${lat}&lon=${lon}&radius=${radius}`;
            },
            error => {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞.');
            }
        );
    } else {
        alert('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é.');
    }
});

// –ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
let page = 1;
let loading = false;
let hasMore = true;

window.addEventListener('scroll', () => {
    if (loading || !hasMore) return;

    const scrollPosition = window.innerHeight + window.scrollY;
    const pageHeight = document.body.offsetHeight;

    if (scrollPosition >= pageHeight - 300) {  // 300px –¥–æ –∫–æ–Ω—Ü–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loading = true;
        loadMoreAds();
    }
});

function loadMoreAds() {
    const urlParams = new URLSearchParams(window.location.search);
    const q = urlParams.get('q') || '';
    const near_city = urlParams.get('near_city') || '';
    const radius = urlParams.get('radius') || 400;
    const lat = urlParams.get('lat') || '';
    const lon = urlParams.get('lon') || '';

    fetch(`/load_more?page=${page + 1}&q=${encodeURIComponent(q)}&near_city=${encodeURIComponent(near_city)}&radius=${radius}&lat=${lat}&lon=${lon}`)
        .then(response => response.json())
        .then(data => {
            if (data.ads.length === 0) {
                hasMore = false;
                return;
            }

            const container = document.querySelector('.row');
            data.ads.forEach(ad => {
                const card = `
                    <div class="col-md-4 mb-4">
                        <div class="card h-100">
                            ${ad.image ? `<img src="/static/uploads/${ad.image}" class="card-img-top" style="height:200px; object-fit:cover;">` : ''}
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${ad.title}</h5>
                                <p class="card-text flex-grow-1">${ad.description.substring(0, 150)}...</p>
                                <p class="card-text"><strong>–¶–µ–Ω–∞: ${ad.price} ‚ÇΩ</strong></p>
                                ${data.nearby_mode && ad.distance ? `<p class="card-text text-success"><strong>‚âà ${ad.distance} –∫–º</strong></p>` : ''}
                                <p class="card-text text-muted"><small>–ü—Ä–æ–¥–∞–≤–µ—Ü –∏–∑: ${ad.seller_city}</small></p>

                                ${data.current_user_authenticated ? `
                                    <form method="POST" action="/toggle_favorite/${ad.id}" class="mt-2">
                                        ${ad.is_favorite ? 
                                            '<button type="submit" class="btn btn-outline-danger btn-sm">–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ</button>' :
                                            '<button type="submit" class="btn btn-outline-primary btn-sm">–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>'
                                        }
                                    </form>
                                ` : ''}

                                <a href="/ad/${ad.id}" class="btn btn-success mt-auto">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', card);
            });

            page += 1;
            loading = false;
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–≥—Ä—É–∑–∫–∏:', error);
            loading = false;
        });
}
</script>

<!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
<div class="row mb-4">
    <div class="col">
        <h5>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:</h5>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm me-2">–í—Å–µ</a>
        {% for cat in categories %}
            <a href="{{ url_for('category', cat_id=cat.id) }}" class="btn btn-outline-success btn-sm me-2">{{ cat.name }}</a>
        {% endfor %}
    </div>
</div>

<!-- –û–±—ä—è–≤–ª–µ–Ω–∏—è (–Ω–∞—á–∞–ª—å–Ω—ã–µ 12) -->
<div class="row" id="ads-container">
    {% for ad in ads %}
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            {% if ad.image %}
                <img src="{{ url_for('static', filename='uploads/' + ad.image) }}" class="card-img-top" style="height:200px; object-fit:cover;">
            {% endif %}
            <div class="card-body d-flex flex-column">
                <h5 class="card-title">{{ ad.title }}</h5>
                <p class="card-text flex-grow-1">{{ ad.description[:150] }}...</p>
                <p class="card-text"><strong>–¶–µ–Ω–∞: {{ ad.price }} ‚ÇΩ</strong></p>
                {% if nearby_mode and ad.distance is defined %}
                    <p class="card-text text-success"><strong>‚âà {{ ad.distance }} –∫–º</strong></p>
                {% endif %}
                <p class="card-text text-muted"><small>–ü—Ä–æ–¥–∞–≤–µ—Ü –∏–∑: {{ ad.seller.city }}</small></p>

                {% if current_user.is_authenticated %}
                    <form method="POST" action="{{ url_for('toggle_favorite', ad_id=ad.id) }}" class="mt-2">
                        {% if ad in current_user.favorites %}
                            <button type="submit" class="btn btn-outline-danger btn-sm">–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ</button>
                        {% else %}
                            <button type="submit" class="btn btn-outline-primary btn-sm">–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
                        {% endif %}
                    </form>
                {% endif %}

                <a href="{{ url_for('ad_detail', ad_id=ad.id) }}" class="btn btn-success mt-auto">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
            </div>
        </div>
    </div>
    {% else %}
    <p>–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç. –î–æ–±–∞–≤—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ!</p>
    {% endfor %}
</div>
{% endblock %}
